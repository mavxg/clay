<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title></title>
	<script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,700|Inconsolata" />
<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/pure-min.css"/>

<!--[if lte IE 8]>
    <link rel="stylesheet" href="css/layouts/side-menu-old-ie.css">
<![endif]-->
<!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="css/layouts/side-menu.css">
<!--<![endif]-->


<script src="js/clay.js"></script>
<script src="js/parser.js"></script>
<style>
html { font-family: "Open Sans","Segoe UI",verdana , sans-serif; 
background: #fff; color: #777; }

table {
	min-width: 100%;
}

h1, h2, h3, h4, h5, h6 {
color: rgb(75, 75, 75);
text-rendering: optimizeLegibility;
line-height: 1;
margin-top: 0;
font-weight: 300;
}

#preview h1 { font-size: 50.66px;
font-family: "Open Sans", "Segoe UI Light","Segoe WP Light", verdana , sans-serif; 
}
#preview h2 {  
padding-top: 0.8em;
margin-top: 0.8em;
border-top: #edece4 1px solid;
}

#preview h1 {
	padding-top: 0.8em;
	margin-top: 0.8em;
}

pre {
margin: 1.6em 0;
box-sizing: border-box;
background: rgb(250, 250, 250);
border: 1px solid #eee;
width: 100%;
padding: 10px;
font-size: 0.9em;
/*white-space: pre;*/
/*border-radius: 3px;*/
}

code, kbd, pre, samp {
font-family: Consolas, Inconsolata, monospace;
font-size: 1em;
color: #333;
}

pre code, pre tt {
font-size: inherit;
/*white-space: -moz-pre-wrap;*/
white-space: pre-wrap;
background: transparent;
border: none;
padding: 0;
}

blockquote {
margin: 1.6em 0;
box-sizing: border-box;
padding: 0 1.6em 0 1.6em;
border-left: #edece4 0.6em solid;
}

#main {
	padding-top: 30px; /* TODO If you add margin then you need to take that into account for the cursor */
}

div.modal #preview {
	display: none;
}

#preview {
	position: relative;
	box-sizing: border-box;
}

#model {
	height: 100px;
	background: white;
	border: 1px solid #efefef;
}


span.cursor {
  position: absolute;
  background: #111;
  margin-right: -1px;
  width: 1px;
  display: block;
  z-index: 100;
 
  -webkit-animation: blink 2s linear 0s infinite;
  -moz-animation: blink 2s linear 0s infinite;
  -ms-animation: blink 2s linear 0s infinite;
  -o-animation: blink 2s linear 0s infinite;
}


@-webkit-keyframes blink {
  0%   { background: #aa0 }
  47%  { background: #999 }
  50%  { background: #000 }
  97%  { background: #000 }
  100% { background: #090 }
}
 
@-moz-keyframes blink {
  0%   { background: #aa0 }
  47%  { background: #999 }
  50%  { background: #000 }
  97%  { background: #000 }
  100% { background: #999 }
}
 
@-ms-keyframes blink {
  0%   { background: #aa0 }
  47%  { background: #999 }
  50%  { background: #000 }
  97%  { background: #000 }
  100% { background: #999 }
}
 
@-o-keyframes blink {
  0%   { background: #aa0 }
  47%  { background: #999 }
  50%  { background: #000 }
  97%  { background: #000 }
  100% { background: #999 }
}

h1 span.before,
h2 span.before,
h3 span.before,
h4 span.before,
h5 span.before,
blockquote span.before,
li > span.before {
	position: absolute;
	right: 100%;
	margin-right: 3px;
}

code > span > span.before {
	position: absolute;
	right: 100%;
	margin-right: 13px;
}

code { position: relative; }
code > span.before {
position: absolute;
top: -38px;
}

code > span.after {
	position: absolute;
	margin-top: 10px;
}

span.meta {
	display: block;
}

span.result::before {
	content: " = ";
}

div.result {
	margin-bottom: 0.8em;
}

.result {
	color: rgb(151, 168, 182);
}

span.meta {
	color: rgb(151, 168, 182);
}

span.before,
span.after {
	color: rgb(202, 224, 243);
}

code span.hide {
	display: none;
}


tr.align td {
	padding-top: 0;
	padding-bottom: 0;
}

tr.align {
	color: rgb(15, 135, 238);
	position: 
}


.models {
	list-style-type: none;
	margin: 0;
	padding: 0;
	padding-bottom: 3em;
	text-align: center;
}

.models li {
	padding: 0.8em 0;
	background: #f7f7f7;
	border-bottom: 1px solid #e7e7e7;
}

.models li a {
	text-decoration: none;
}


.debug { 
	position: fixed;
	top: 0;
	left: 0;
	right: 0px;
	z-index: 100;
}
@media (min-width: 48em) {
	.debug {
		margin-left: 150px;	
	}
}

div.selection {
	top: 0;
	left: 0;
	position: absolute;
	padding: 0;
	margin: 0;
	z-index: 100;
	display: block;
}

div.selection div {
	background: rgba(0, 128, 236, 0.51);
	box-sizing: border-box;
	position: absolute;
	padding: 0;
	margin: 0;
}

#menu .menu-modified {
    border-right: 10px solid rgb(34, 92, 141);
}
</style>
</head>

<body>
<div class='debug'>
<div class='content'>
<textarea id="model" class="editor pure-u-5-5">
# Clay

Requires Chrome, Firefox, or IE9>.
</textarea>	
</div>
</div>
<div id="layout">
    <!-- Menu toggle -->

    <div id="main">
<div class="content">
	
<div id="preview" class="editor">
</div>
</div>
</div>
</div>
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
<script type="text/javascript" src="/js/react/react-with-addons.js"></script>
<script type="text/javascript" src="/js/functions.js"></script>

<script type="text/javascript">
var title = "Clay"
var DOM = React.DOM,
	div = DOM.div, ul = DOM.ul, li = DOM.li, p = DOM.p
	h1 = DOM.h1, h2 = DOM.h2, a = DOM.a, span = DOM.span;


//helper string functions
if (typeof String.prototype.startsWith != 'function') {
  String.prototype.startsWith = function (str){
    return this.slice(0, str.length) == str;
  };
}

var Clay = function() {
	this._blank = true;
	this.names = [{name:'Blank'}];
	this._sources = {'Blank': '# Blank\n\nEnter your model here.'};
	this._asts = {};
	this._rendered = {};
	this._model;
};

Clay.prototype.getSource = function(name) {
	return this._sources[name];
};

Clay.prototype.close = function(name) {
	delete this._sources[name];
	delete this._asts[name];
	delete this._rendered[name];
	var i = this.names.length;
	while (i--)
		if (this.names[i].name == name) 
				break;
	if (i >= 0)
		this.names.splice(i, 1);
	//this.recalc()
	if (this.names.length === 0) {
		this.names = [{name:'Blank'}];
		this._sources = {'Blank': '# Blank\n\nEnter your model here.'};
		this._blank	= true;
		this.recalc('Blank');
	}
};

Clay.prototype.charOffset = function(name, path, toff) {
	var node = {}, path = path.reverse(), cur, off = 0, row;
	node.children = this._asts[name] || [];
	while ((cur = path.pop()) !== undefined) {
		if (cur === '_') continue;
		else if (cur === 'result') return node.pos + node.length; //off + // no toff
		node = node.children[cur];
		if (node === undefined) return off + toff;
		off = node.pos; //+= //change pos to be against level
		if (node.type === 'table') {
			switch(cur = path.pop()) {
				case 'body':
					row = path.pop();
					cur = path.pop();
					node = {children: node.cells[row][cur]};
					break;
				case 'head':
					row = path.pop(); //should be 0
					cur = path.pop();
					if (row === 'align') {
						off = node.align.pos;
						for (var i = 0; i < cur; i++) {
							off += node.alignText[i].length + 1;
						}
						return off + toff;
					} else {
						node = {children: node.header[cur]};
					}
					break;
				//case 'foot': 
				//	return off + toff; //TODO: don't support foot yet
			}
		}
	}
	return off + toff;
};

Clay.prototype.addModel = function(name, source) {
	if (this._blank && !this.name('Blank').modified) {
		this.names = [];
		this._sources = {};
		this._blank = false;
	}
	this._sources[name] = source;
	this.names.push({name: name});
	this.recalc(name);
};

Clay.prototype.openModel = function(name, callback) {
	if (this._sources[name] !== undefined) {
		if (callback) callback(name); //file already open just switch to it
	} else {
		fetchFile('/models/'+name + '.model', function(data) {
			if (data !== undefined) {
				this.addModel(name, data);
				if (callback) callback(name);
			}
		}.bind(this));
	}
};

Clay.prototype.revert = function(name, callback) {
	fetchFile('/models/'+name + '.model', function(data) {
		if (data !== undefined) {
			this.update(name, data);
			this.name(name).modified = false;
			if (callback) callback(name);
		}
	}.bind(this));
};

Clay.prototype.recalc = function(name) {
	var source = this._sources[name],
		lex = clay.lexer(source);
	this._asts[name] = clay.parser(lex);
};

Clay.prototype.update = function(name, source) {
	var s = this._sources[name];
	if (s != source) {
		this._sources[name] = source;
		this.setModified(name);
		this.recalc(name);
	}
};

Clay.prototype.setModified = function(name) {
	this.name(name).modified = true;
};

Clay.prototype.name = function(name) {
	var i = this.names.length;
	while (i--)
		if (this.names[i].name == name)
			return this.names[i];
	return {}
};

var MenuToggle = React.createClass({
	render: function() {
		return a({href:"#menu", id:"menuLink", className:"menu-link"}, span(null));
	},
});

var MenuItem = React.createClass({
	clicked: function(event) {
		this.props.clicked(this.props.item.name);
	},
	render: function() {
		var item = this.props.item,
			classes = React.addons.classSet({
			'menu-item-divided': this.props.divided,
			'pure-menu-selected': this.props.selected,
			'menu-modified': item.modified,
		});
		return li({onClick: this.clicked, className: classes},
			a({href:"#" + item.name}, item.name))
	},
});

var Menu = React.createClass({
	renderItem: function(item,idx) {
		return MenuItem({item:item, 
			key: idx,
			divided: item.separator, 
			selected: (item.name == this.props.selected), 
			clicked: item.func});
	},
	renderFile: function(item, idx) {
		return MenuItem({item:item, 
			divided: (idx == 0),
			key: idx,
			selected: (item.name == this.props.selected), 
			clicked: this.props.fileClick});
	},
	render: function() {

		return div({id:"menu"},
			div({className:"pure-menu pure-menu-open"},
				a({className:"pure-menu-heading", href:"#"},title),
				ul(null,this.props.items.map(this.renderItem),
					this.props.files.map(this.renderFile))));
	},
});

var FileItem = React.createClass({
	clicked: function(event) {
		this.props.clicked(this.props.path + this.props.item.name.replace(/\.model$/,''));
	},
	render: function() {
		var item = this.props.item.name,
			name = this.props.path + item.replace(/\.model$/,'');
		return li({onClick: this.clicked},
			a({href:"#" + name}, name))
	},
});

var DirectoryItem = React.createClass({
	renderItem: function(item, idx) {
		if (item.type === 'directory') {
			return DirectoryItem({clicked: this.props.clicked,
				key: idx,
				directory: item,
				path: this.props.path + item.name + '/'});
		}
		return FileItem({clicked: this.props.clicked, key: idx, item: item, path: this.props.path});
	},
	render: function() {
		return ul({className: 'models'}, this.props.directory.children.map(this.renderItem));
	},
});

var FileList = React.createClass({
	getInitialState: function() {
		return {data: []};
	},
	componentWillMount: function() {
		$.ajax({
			url: 'models.json',
			dataType: 'json',
			success: function(data) {
				this.setState({data: data});
			}.bind(this),
			error: function(xhr, status, err) {
				console.error('models.json', status, err.toString());
			}.bind(this)
		});
	},
	render: function() {
		return div(null,
			div({className: 'header'}, h1(null, "Open Model"), h2(null, "Choose a model to open")),
			DirectoryItem({directory:{children: this.state.data}, path:'', clicked: this.props.clicked}));
	},
});

var Selection = React.createClass({
	getInitialState: function() {
		return {
			selection: null,
		}
	},
	componentDidUpdate: function() {
		/*var rects, rect;
		if (this.state.selection !== null &&
			(rects = this.state.selection.getClientRects()).length > 0) {
			rect = rects[0];
			window.scrollTo(rect.left, rect.top);
		}*/
	},
	renderSelection: function(range) {
		var rects = range.getClientRects(),
			r = range.getBoundingClientRect()
		  , ret = []
		  , cs
		  , fbot
		  , rect
		  , farLeft = Math.floor(r.left)
		  , farRight = Math.ceil(r.right)
		  , scrollTop = document.documentElement.scrollTop || document.body.scrollTop
          , scrollLeft = document.documentElement.scrollLeft || document.body.scrollLeft
          , len = rects.length
          , i;
        if (len > 0) {
        	rect = rects[0];
        	cs = {
        		top: (rect.top + scrollTop) + 'px',
        		left: (rect.left + scrollLeft) + 'px',
        		height: rect.height + 'px',
        		width: (farRight - rect.left) + 'px',
        	}
			fbot = rect.bottom;
        	ret.push(div({style:cs, key:'first'}," "));
        }
        if (len > 1) {
        	rect = rects[len - 1];
        	cs = {
        		left: (farLeft + scrollLeft) + 'px',
        		width: (rect.right - farLeft) + 'px',
        	}
			var gap = rect.top - fbot;
			if (gap < rect.height * 0.6) {
				cs.top = (rect.top + scrollTop - gap) + 'px';
        		cs.height = (rect.height + gap) + 'px';
			} else {
        		cs.top = (rect.top + scrollTop) + 'px';
        		cs.height = rect.height + 'px';
        		// now draw the gap
        		ret.push(div({style: {
        			top: (fbot + scrollTop) + 'px',
        			left: (farLeft + scrollLeft) + 'px',
        			width: (farRight - farLeft) + 'px',
        			height: gap + 'px'
        		}, key: 'mid'}, " "));
			}
			ret.push(div({style: cs, key: 'last'}, " "));
        }
        return ret;
	},
	render: function() {
		var range = this.state.selection; //selection range
		if (range === null)
			return div(null);

		var rects = range.getClientRects(),
			scrollTop = document.documentElement.scrollTop || document.body.scrollTop,
        	scrollLeft = document.documentElement.scrollLeft || document.body.scrollLeft;
        if (rects.length === 0)
        	return div(null);

		if (range.collapsed) {
			var rect = rects[0],
				cs = {
					top: (rect.top + scrollTop) + 'px',
					left: (rect.right + scrollLeft - 1) + 'px',
					height: rect.height + 'px',
					display: 'block',
				};
			return div(null,span({className: "cursor", style: cs}, " "));
		} else {
			return div({className: "selection"},
				this.renderSelection(range));
		}
	},
});

var Renderer = React.createClass({
	rangeFor: function(start, end) {
		var rootId = this._rootNodeID + '.',
			range = document.createRange(),
			ast = this.props.model._asts[this.props.name];
		function setEnd(items, pos, isStart) {
			var item,
			i,l,path = [];
			while(items !== undefined) {
				l = items.length;
				for(i = 0; i < l; i++) {
					item = items[i];
					if (item.pos > pos) {
						break;
					}
				}
				item = items[--i];
				path.push('$' + i);
				switch(item.type) {
					case 'code':
						//path.push('$_'); //pre
						path.push('$_'); //code
						break;
					//case 'codespan':
					//	path.push('$_'); //code
					//	break;
					case 'table':
						if (pos < item.cells.pos) {
							path.push('$head');
							if (pos < item.align.pos) {
								path.push('$0');
								item = item.header;
							} else {
								path.push('$align');
								var tw = item.align.pos,w;
								for (i = 0; i < item.alignText.length; i++) {
									w = item.alignText[i].length + 1;
									if (pos < w + tw) {
										path.push('$' + i);
										item = {pos: tw};
										break;
									}
									tw += w;
								}
							}
						}
						else {
							path.push('$body');
							item = item.cells;
						}
						break;
				}
				if (item.hasOwnProperty('children')) {
					items = item.children;
				} else if ($.isArray(item)) {
					//items are a
					items = item;
				} else {
					items = undefined;
					pos -= item.pos;
				}
			}
			var x = $('[data-reactid="'+ rootId + path.join('.')+'"]')[0];
			if (x !== undefined)
				if (isStart)
					if (pos > x.firstChild.length) {
						range.setStartAfter(x.firstChild);
					}
					else {
						range.setStart(x.firstChild, pos);
					}
				else
					if (pos > x.firstChild.length) {
						range.setEndAfter(x.firstChild);
					}
					else {
						range.setEnd(x.firstChild, pos);
					}
		}
		setEnd(ast, start, true);
		if (start === end)
			range.setEnd(range.startContainer, range.startOffset);
		else
			setEnd(ast, end, false);
		return range;
	},
	handleMouseUp: function(e) {
		var x = this.props.selectionChanged;
		if (x) {
			//calculate the selection from the data-ids
			var selected = window.getSelection();
			if (selected.rangeCount < 1)
				return;
			var range = selected.getRangeAt(0),
				startE = range.startContainer.parentElement || range.startContainer.parentNode,
				endE = range.endContainer.parentElement || range.endContainer.parentNode,
				startPath = startE.getAttribute('data-reactid'),
				endPath = endE.getAttribute('data-reactid'),
				rootId = this._rootNodeID + '.';
			if (startPath !== undefined 
				&& endPath !== undefined
				&& startPath.startsWith(rootId)
				&& endPath.startsWith(rootId)) {
				var model = this.props.model, name = this.props.name;
				startPath = startPath.slice(rootId.length).replace(/\$?/g,'').split('.');
				endPath = endPath.slice(rootId.length).replace(/\$?/g,'').split('.');
				var start = model.charOffset(name,startPath, range.startOffset);
				var end = model.charOffset(name,endPath, range.endOffset);
				x(start, end);
			}
		}
	},
	renderHeading: function(item, idx) {
		var id = this.props.name + '-' + item.id,
			content = item.children.map(this.renderTree),
			attr = {id: id, key: idx};
		switch(item.depth) {
			case 1: return h1(attr, content);
			case 2: return h2(attr, content);
			case 3: return DOM.h3(attr, content);
			case 4: return DOM.h4(attr, content);
			case 5: return DOM.h5(attr, content);
			case 6: return DOM.h6(attr, content);
		}
		return h1(attr, content);
	},
	renderCode: function(item, idx) {
		return DOM.pre({key: idx}, DOM.code({key: '_'}, item.children.map(this.renderTree)));
	},
	renderResult: function(item, idx) {
		if (item.code.type === 'codespan') {
			return span({className: 'result', key: idx}, 
				item.code.result);
		} else {
			return div({className: 'result', key: idx}, 
				item.code.result.map(function(c, i) { return div({key: i}, c); }));
		}
	},
	renderTable: function(item, idx) {
		var align = item.align, rtree = this.renderTree;
		function renderCell(f) {
			return function(c, idx) {
				var a = align[idx], ctx = {key:idx};
				if (a !== null) {
					ctx['style'] = {'text-align': a};
				}
				return f(ctx, c.map(rtree)); 
			}
		}
		function renderTR(r, idx) {
			return DOM.tr({key: idx}, r.map(renderCell(DOM.td)));
		}
		function renderAlign(c, idx) {
			var a = align[idx], ctx = {key:idx};
				if (a !== null) {
					ctx['style'] = {'text-align': a};
			}
			return DOM.td(ctx, c);
		}
		return DOM.table({key: idx, className: 'pure-table pure-table-horizontal'},
			DOM.thead({key:'head'},
				DOM.tr({key: 0}, item.header.map(renderCell(DOM.th))),
				DOM.tr({key: 'align', className: 'align'}, item.alignText.map(renderAlign))),
			DOM.tbody({key:'body'},item.cells.map(renderTR))//,
			//DOM.tfoot({key:'foot'})
			);
	},
	renderTree: function(item, idx) {
		switch(item.type) {
			case 'text': return span({key: idx},item.text.
				replace(/  /g, '\u2423 '));
			case 'escape': return span({key: idx, dangerouslySetInnerHTML:{__html: item.text}});
			case 'span': return span({key: idx}, item.children.map(this.renderTree));
			case 'meta': return span({key: idx, className: 'meta'}, item.text);
			case 'before': return span({className: 'before', key:idx}, 
				item.text.replace(/ /g,'\u2423').replace(/\t/,'\u2192')); // + (item.newline ? '\n' : '')
			case 'after': 
				var text = item.text.replace(/ /g,'\u2423').replace(/\n/g,'\u00AC');
				if (text.length === 0)
					text = ' '
				return span({className: 'after', key:idx},  text);
			case 'p': return p({key: idx}, item.children.map(this.renderTree));
			case 'em': return DOM.em({key: idx}, item.children.map(this.renderTree));
			case 'strong': return DOM.strong({key: idx}, item.children.map(this.renderTree));
			case 'del': return DOM.del({key: idx}, item.children.map(this.renderTree));
			case 'a': return DOM.a({key: idx, href: item.href, title: item.title}, item.children.map(this.renderTree));
			case 'section': return DOM.section({key: idx}, item.children.map(this.renderTree));
			case 'heading': return this.renderHeading(item, idx);
			case 'table': return this.renderTable(item, idx);
			case 'blockquote': return DOM.blockquote({key: idx}, item.children.map(this.renderTree));
			case 'ul': return ul({key: idx}, item.children.map(this.renderTree));
			case 'ol': return ol({key: idx}, item.children.map(this.renderTree));
			case 'li': return li({key: idx}, item.children.map(this.renderTree));
			case 'hr': return DOM.hr({key: idx}); //TODO
			case 'br': return DOM.br({key: idx}); //TODO
			case 'code': return this.renderCode(item, idx);
			case 'codespan': return DOM.code({key: idx}, item.text);
			case 'html': return div({key: idx,
				dangerouslySetInnerHTML:{__html: item.raw}
				});
			case 'result': return this.renderResult(item, idx);
			default: return p({key: idx},'unsupported: ' + item.type);
		};
	},
	render: function() {
		var ast = this.props.model._asts[this.props.name];
		if (ast === undefined)
			ast = [];
		return div({id: 'preview', 
			ref: 'preview',
			onMouseUp: this.handleMouseUp,
			className: 'editor', 
			//dangerouslySetInnerHTML:{__html: this.props.model._rendered[this.props.name]}
      		}, ast.map(this.renderTree)
      		); 
	},
});

var Editor = React.createClass({
	getInitialState: function() {
		return {
			//TODO this should be an empty model
			currentSource: 'Test of this',
			selected: 'Example',
			modal: null,
		}
	},
	handleChange: function(e) {
		var source = this.refs.textarea.getDOMNode().value;
		this.setState({currentSource: source});
		this.props.model.update(this.state.selected, source);
	},
	save: function() { console.log('save'); },
	saveAll: function() { console.log('saveAll'); },
	open: function() {
		this.setState({modal: this.openModal});
	},
	close: function() { 
		this.props.model.close(this.state.selected);
		this.switchFile(this.props.model.names[0].name);
	},
	revert: function() {
		this.props.model.revert(this.state.selected, this.switchFile);
	},
	openFile: function(path) {
		this.props.model.openModel(path, this.switchFile);
	},
	preview: function() {
		return 
	},
	openModal: function() {
		return FileList({clicked: this.openFile});
	},
	switchFile: function(name) { 
		console.log('switchFile: ' + name);
		var source = this.props.model.getSource(name),
		    ta = this.refs.textarea.getDOMNode();
		this.setState({ selected: name,
			currentSource: source,
			modal: null});
		ta.value = source; //React doesn't set the value of the text area
		ta.setSelectionRange(0,0);
	},
	componentDidMount: function() {
		this.openFile('Example'); //TODO pass in as initial model
	},
	componentDidUpdate: function(prevProps, prevState) {
		this.updateCursor();
	},
	menu: function() {
		// must be wrapped in a function to see the other functions
		// i.e. this.openFile
		// could be done on ComponentWillMount to save a call every time
		return [
			{name: "Open", func: this.open},
			{name: "Close", func: this.close},
			{name: "Revert", func: this.revert},
			{name: "Save", func: this.save, separator: true},
			{name: "Save All", func: this.saveAll},
			];
	},
	updateCursor: function() {
		//TODO might want this to ignore the 
		var ta = this.refs.textarea.getDOMNode(),
		    range = this.refs.preview.rangeFor(ta.selectionStart, ta.selectionEnd),
		    rect = range.getClientRects()[0];
		if (rect) {

		}
		this.refs.selection.setState({selection: range});
	},
	handleKeyDown: function(e) {
		if (e.keyCode === 9 && !e.altKey && !e.ctrlKey && !e.shiftKey) { //tab
			var ta = this.refs.textarea.getDOMNode(),
				val = ta.value,
				start = ta.selectionStart,
				end = ta.selectionEnd;
			ta.value = val.substring(0,start) + '\t' + val.substring(end);
			ta.selectionStart = ta.selectionEnd = start + 1;
			this.setState({currentSource: ta.value});
			//manually trigger update
			this.props.model.update(this.state.selected, ta.value);
			return false;
		}
		return true;
	},
	//Note: these are getting called every click...
	handleBlur: function() {
		this.refs.selection.setState({selection: null});
	},
	handleFocus: function() {
		//textarea gained focus (draw selection)
		this.updateCursor();
	},
	handleKeyUp: function() {
		this.updateCursor();
	},
	handleSelect: function(start, end) {
		var ta = this.refs.textarea.getDOMNode();
		ta.setSelectionRange(start, end); //do this before and after focus so update cursor works
		ta.focus();
		ta.setSelectionRange(start, end); //TODO: remove (just here to scroll the text area)
		this.updateCursor();
	},
	render: function() {
		return div({className: (this.state.modal !== null ? "modal" : "view")},
			DOM.textarea({id: 'model', 
						onChange: this.handleChange,
						onKeyDown: this.handleKeyDown,
						onKeyUp: this.handleKeyUp,
						onFocus: this.handleFocus,
						onBlur: this.handleBlur,
						ref: "textarea", 
						style: {opacity: '0', position: 'fixed', width: '100%', 'max-width': '800px'},
						defaultValue: this.props.model.getSource(this.state.selected)}),
			div({id:'layout'},
				MenuToggle(null),
				Menu({items: this.menu(), files:this.props.model.names, 
					selected:this.state.selected, fileClick: this.switchFile}),
				div({id:'main'},
					div({className:'content'},
						Selection({ref: 'selection'}),
						(this.state.modal === null ? null : this.state.modal()), //Dialog box
						Renderer({model:this.props.model, 
							ref: 'preview',
							name:this.state.selected,
							selectionChanged: this.handleSelect,
							})
						))));
	},
});


var models = new Clay();
//models.addModel("Getting Started", "# Some stuff here\n\nOther stuff");
//models.addModel("Benchmarks","# Benchmarks\n\nNothing to see here");
var ed = Editor({model: models});
React.renderComponent(ed, document.body);
//ed.openFile('Example');
</script>
<script src="js/ui.js"></script>

</body>
</html>