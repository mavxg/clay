<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title></title>
	<script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,700|Inconsolata" />
<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/pure-min.css"/>

<!--[if lte IE 8]>
    <link rel="stylesheet" href="css/layouts/side-menu-old-ie.css">
<![endif]-->
<!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="css/layouts/side-menu.css">
<!--<![endif]-->


<script src="js/clay.js"></script>
<style>
html { font-family: "Open Sans","Segoe UI",verdana , sans-serif; 
background: #fff; color: #777; }

table {
	min-width: 100%;
}

h1, h2, h3, h4, h5, h6 {
color: rgb(75, 75, 75);
text-rendering: optimizeLegibility;
line-height: 1;
margin-top: 0;
font-weight: 300;
}

#preview h1 { font-size: 50.66px;
font-family: "Open Sans", "Segoe UI Light","Segoe WP Light", verdana , sans-serif; 
}
#preview h2 {  
padding-top: 0.8em;
margin-top: 0.8em;
border-top: #edece4 1px solid;
}

pre {
margin: 1.6em 0;
box-sizing: border-box;
background: rgb(250, 250, 250);
border: 1px solid #eee;
width: 100%;
padding: 10px;
font-size: 0.9em;
/*white-space: pre;*/
/*border-radius: 3px;*/
}

code, kbd, pre, samp {
font-family: Consolas, Inconsolata, monospace;
font-size: 1em;
color: #333;
}

pre code, pre tt {
font-size: inherit;
/*white-space: -moz-pre-wrap;*/
white-space: pre-wrap;
background: transparent;
border: none;
padding: 0;
}

blockquote {
margin: 1.6em 0;
box-sizing: border-box;
padding: 0 1.6em 0 1.6em;
border-left: #edece4 0.6em solid;
}

#main {
	padding-top: 130px; /* TODO If you add margin then you need to take that into account for the cursor */
}

#preview {
	position: relative;
	box-sizing: border-box;
}

#model {
	height: 100px;
	background: white;
	border: 1px solid #efefef;
}


span.cursor {
  position: absolute;
  background: #111;
  margin-right: -1px;
  width: 1px;
  display: block;
  z-index: 100;
 
  -webkit-animation: blink 2s linear 0s infinite;
  -moz-animation: blink 2s linear 0s infinite;
  -ms-animation: blink 2s linear 0s infinite;
  -o-animation: blink 2s linear 0s infinite;
}


@-webkit-keyframes blink {
  0%   { background: #aa0 }
  47%  { background: #999 }
  50%  { background: #000 }
  97%  { background: #000 }
  100% { background: #090 }
}
 
@-moz-keyframes blink {
  0%   { background: #aa0 }
  47%  { background: #999 }
  50%  { background: #000 }
  97%  { background: #000 }
  100% { background: #999 }
}
 
@-ms-keyframes blink {
  0%   { background: #aa0 }
  47%  { background: #999 }
  50%  { background: #000 }
  97%  { background: #000 }
  100% { background: #999 }
}
 
@-o-keyframes blink {
  0%   { background: #aa0 }
  47%  { background: #999 }
  50%  { background: #000 }
  97%  { background: #000 }
  100% { background: #999 }
}

h1 .before,
h2 .before,
h3 .before,
h4 .before,
h5 .before {
	position: absolute;
	right: 100%;
	margin-right: 3px;
}

span.before,
span.after {
	color: rgb(202, 224, 243);
}

code span.hide {
	display: none;
}


.models {
	list-style-type: none;
	margin: 0;
	padding: 0;
	padding-bottom: 3em;
	text-align: center;
}

.models li {
	padding: 0.8em 0;
	background: #f7f7f7;
	border-bottom: 1px solid #e7e7e7;
}

.models li a {
	text-decoration: none;
}


.debug { 
	position: fixed;
	top: 0;
	left: 0;
	right: 0px;
	z-index: 100;
}
@media (min-width: 48em) {
	.debug {
		margin-left: 150px;	
	}
}

div.selection {
	top: 0;
	left: 0;
	position: absolute;
	padding: 0;
	margin: 0;
	z-index: 100;
	display: block;
}

div.selection div {
	background: rgba(0, 128, 236, 0.51);
	box-sizing: border-box;
	position: absolute;
	padding: 0;
	margin: 0;
}

#menu .menu-modified {
    border-right: 10px solid rgb(34, 92, 141);
}
</style>
</head>

<body>
<div class='debug'>
<div class='content'>
<textarea id="model" class="editor pure-u-5-5">
# Clay

Requires Chrome, Firefox, or IE9>.
</textarea>	
</div>
</div>
<div id="layout">
    <!-- Menu toggle -->

    <div id="main">
<div class="content">
	
<div id="preview" class="editor">
</div>
</div>
</div>
</div>
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
<script type="text/javascript" src="/js/react/react-with-addons.js"></script>
<script type="text/javascript" src="/js/functions.js"></script>

<script type="text/javascript">
var title = "Clay"
var DOM = React.DOM,
	div = DOM.div, ul = DOM.ul, li = DOM.li, p = DOM.p
	h1 = DOM.h1, h2 = DOM.h2, a = DOM.a, span = DOM.span;


//helper string functions
if (typeof String.prototype.startsWith != 'function') {
  String.prototype.startsWith = function (str){
    return this.slice(0, str.length) == str;
  };
}

var Clay = function() {
	this._blank = true;
	this.names = [{name:'Blank'}];
	this._sources = {'Blank': '# Blank\n\nEnter your model here.'};
	this._asts = {};
	this._rendered = {};
	this._model;
};

Clay.prototype.getSource = function(name) {
	return this._sources[name];
};

Clay.prototype.close = function(name) {
	delete this._sources[name];
	delete this._asts[name];
	delete this._rendered[name];
	var i = this.names.length;
	while (i--)
		if (this.names[i].name == name) 
				break;
	if (i >= 0)
		this.names.splice(i, 1);
	//this.recalc()
	if (this.names.length === 0) {
		this.names = [{name:'Blank'}];
		this._sources = {'Blank': '# Blank\n\nEnter your model here.'};
		this._blank	= true;
		this.recalc('Blank');
	}
};

Clay.prototype.charOffset = function(name, path, toff) {
	var node = {}, path = path.reverse(), cur, off = 0;
	node.children = this._asts[name] || [];
	while ((cur = path.pop()) !== undefined) {
		if (cur === 'before') return node.pos - node.before.length + toff; //off +
		if (cur === 'after')  return node.pos + node.length + toff;
		if (cur === 'result') return node.pos + node.length; //off + // no toff
		if (cur === 'text') return node.pos + toff;
		node = node.children[cur];
		if (node === undefined) return off + toff;
		off = node.pos; //+= //change pos to be against level
	}
	return off + toff;
};

Clay.prototype.addModel = function(name, source) {
	if (this._blank && !this.name('Blank').modified) {
		this.names = [];
		this._sources = {};
		this._blank = false;
	}
	this._sources[name] = source;
	this.names.push({name: name});
	this.recalc(name);
};

Clay.prototype.openModel = function(name, callback) {
	if (this._sources[name] !== undefined) {
		if (callback) callback(name); //file already open just switch to it
	} else {
		fetchFile('/models/'+name + '.model', function(data) {
			if (data !== undefined) {
				this.addModel(name, data);
				if (callback) callback(name);
			}
		}.bind(this));
	}
};

Clay.prototype.revert = function(name, callback) {
	fetchFile('/models/'+name + '.model', function(data) {
		if (data !== undefined) {
			this.update(name, data);
			this.name(name).modified = false;
			if (callback) callback(name);
		}
	}.bind(this));
};

Clay.prototype.recalc = function(name) {
	var source = this._sources[name],
		lex = clay.lexer(source),
		lexcopy = lex.slice();
	lexcopy.links = lex.links;
	this._asts[name] = clay.newparser(lexcopy, clay.options);
	this._rendered[name] = clay.parser(lex, clay.options);
};

Clay.prototype.update = function(name, source) {
	var s = this._sources[name];
	if (s != source) {
		this._sources[name] = source;
		this.setModified(name);
		this.recalc(name);
	}
};

Clay.prototype.setModified = function(name) {
	this.name(name).modified = true;
};

Clay.prototype.name = function(name) {
	var i = this.names.length;
	while (i--)
		if (this.names[i].name == name)
			return this.names[i];
	return {}
};

var MenuToggle = React.createClass({
	render: function() {
		return a({href:"#menu", id:"menuLink", className:"menu-link"}, span(null));
	},
});

var MenuItem = React.createClass({
	clicked: function(event) {
		this.props.clicked(this.props.item.name);
	},
	render: function() {
		var item = this.props.item,
			classes = React.addons.classSet({
			'menu-item-divided': this.props.divided,
			'pure-menu-selected': this.props.selected,
			'menu-modified': item.modified,
		});
		return li({onClick: this.clicked, className: classes},
			a({href:"#" + item.name}, item.name))
	},
});

var Menu = React.createClass({
	renderItem: function(item,idx) {
		return MenuItem({item:item, 
			key: idx,
			divided: item.separator, 
			selected: (item.name == this.props.selected), 
			clicked: item.func});
	},
	renderFile: function(item, idx) {
		return MenuItem({item:item, 
			divided: (idx == 0),
			key: idx,
			selected: (item.name == this.props.selected), 
			clicked: this.props.fileClick});
	},
	render: function() {

		return div({id:"menu"},
			div({className:"pure-menu pure-menu-open"},
				a({className:"pure-menu-heading", href:"#"},title),
				ul(null,this.props.items.map(this.renderItem),
					this.props.files.map(this.renderFile))));
	},
});

var FileItem = React.createClass({
	clicked: function(event) {
		this.props.clicked(this.props.path + this.props.item.name.replace(/\.model$/,''));
	},
	render: function() {
		var item = this.props.item.name,
			name = this.props.path + item.replace(/\.model$/,'');
		return li({onClick: this.clicked},
			a({href:"#" + name}, name))
	},
});

var DirectoryItem = React.createClass({
	renderItem: function(item, idx) {
		if (item.type === 'directory') {
			return DirectoryItem({clicked: this.props.clicked,
				key: idx,
				directory: item,
				path: this.props.path + item.name + '/'});
		}
		return FileItem({clicked: this.props.clicked, key: idx, item: item, path: this.props.path});
	},
	render: function() {
		return ul({className: 'models'}, this.props.directory.children.map(this.renderItem));
	},
});

var FileList = React.createClass({
	getInitialState: function() {
		return {data: []};
	},
	componentWillMount: function() {
		$.ajax({
			url: 'models.json',
			dataType: 'json',
			success: function(data) {
				this.setState({data: data});
			}.bind(this),
			error: function(xhr, status, err) {
				console.error('models.json', status, err.toString());
			}.bind(this)
		});
	},
	render: function() {
		return div(null,
			div({className: 'header'}, h1(null, "Open Model"), h2(null, "Choose a model to open")),
			DirectoryItem({directory:{children: this.state.data}, path:'', clicked: this.props.clicked}));
	},
});

var Selection = React.createClass({
	renderSelection: function(range) {
		var rects = range.getClientRects(),
			r = range.getBoundingClientRect()
		  , ret = []
		  , cs
		  , fbot
		  , rect
		  , farLeft = Math.floor(r.left)
		  , farRight = Math.ceil(r.right)
		  , scrollTop = document.documentElement.scrollTop || document.body.scrollTop
          , scrollLeft = document.documentElement.scrollLeft || document.body.scrollLeft
          , len = rects.length
          , i;
        if (len > 0) {
        	rect = rects[0];
        	cs = {
        		top: (rect.top + scrollTop) + 'px',
        		left: (rect.left + scrollLeft) + 'px',
        		height: rect.height + 'px',
        		width: (farRight - rect.left) + 'px',
        	}
			fbot = rect.bottom;
        	ret.push(div({style:cs, key:'first'}," "));
        }
        if (len > 1) {
        	rect = rects[len - 1];
        	cs = {
        		left: (farLeft + scrollLeft) + 'px',
        		width: (rect.right - farLeft) + 'px',
        	}
			var gap = rect.top - fbot;
			if (gap < rect.height * 0.6) {
				cs.top = (rect.top + scrollTop - gap) + 'px';
        		cs.height = (rect.height + gap) + 'px';
			} else {
        		cs.top = (rect.top + scrollTop) + 'px';
        		cs.height = rect.height + 'px';
        		// now draw the gap
        		ret.push(div({style: {
        			top: (fbot + scrollTop) + 'px',
        			left: (farLeft + scrollLeft) + 'px',
        			width: (farRight - farLeft) + 'px',
        			height: gap + 'px'
        		}, key: 'mid'}, " "));
			}
			ret.push(div({style: cs, key: 'last'}, " "));
        }
        return ret;
	},
	render: function() {
		var range = this.props.selection; //selection range
		if (range === null)
			return span(null);

		var rects = range.getClientRects(),
			scrollTop = document.documentElement.scrollTop || document.body.scrollTop,
        	scrollLeft = document.documentElement.scrollLeft || document.body.scrollLeft;
        if (rects.length === 0)
        	return span(null);

		if (range.collapsed) {
			var rect = rects[0],
				cs = {
					top: (rect.top + scrollTop) + 'px',
					left: (rect.right + scrollLeft - 1) + 'px',
					height: rect.height + 'px',
					display: 'block',
				};
			return span({className: "cursor", style: cs}, " ");
		} else {
			return div({className: "selection"},
				this.renderSelection(range));
		}
	},
});

var Renderer = React.createClass({
	rangeFor: function(start, end) {
		var range = document.createRange();

		return range;
	},
	handleMouseUp: function(e) {
		var f = this.props.onmouseup;
		if (f) f(e);
		/*var x = this.props.selectionChanged;
		if (true) {
			//calculate the selection from the data-ids
			var selected = window.getSelection(),
				range = selected.getRangeAt(),
				startE = range.startContainer.parentElement || range.startContainer.parentNode,
				endE = range.endContainer.parentElement || range.endContainer.parentNode,
				startPath = startE.getAttribute('data-reactid'),
				endPath = endE.getAttribute('data-reactid'),
				rootId = this._rootNodeID + '.';
			if (startPath !== undefined 
				&& endPath !== undefined
				&& startPath.startsWith(rootId)
				&& endPath.startsWith(rootId)) {
				var model = this.props.model, name = this.props.name;
				startPath = startPath.slice(rootId.length).replace(/\$_?/g,'');
				startPath = startPath.replace(/\.+/g,'.');
				startPath = startPath.split('.');
				endPath = endPath.slice(rootId.length).replace(/\$_?/g,'').replace(/\.+/g,'.').split('.');
				var start = model.charOffset(name,startPath, range.startOffset);
				var end = model.charOffset(name,endPath, range.endOffset);
			}
		}*/
	},
	renderHeading: function(item, idx) {
		var id = this.props.name + '-' + item.text.toLowerCase().replace(/[^\w]+/g, '-'),
			content = [],
			attr = {id: id, 'data-pos': item.pos, key: idx};
		if (item.before) content.push(span({className: 'before', key:'before', 'data-pos': item.pos - item.before.length},
			item.before.replace(/ /g,'\u2423')));
		content.push(span({key: 'text', 'data-pos': item.pos}, item.text)); //todo this should be a children map
		if (item.before) content.push(span({className: 'after', key:'after', 'data-pos': item.pos + item.length},
			item.after.slice(0,-1).replace(/ /g,'\u2423').replace(/\n/g,'\u00AC')));
		switch(item.depth) {
			case 1: return h1(attr, content);
			case 2: return h2(attr, content);
			case 3: return DOM.h3(attr, content);
			case 4: return DOM.h4(attr, content);
			case 5: return DOM.h5(attr, content);
			case 6: return DOM.h6(attr, content);
		}
		return h1(attr, content);
	},
	renderTable: function(item, idx) {
		return DOM.table({'data-pos': item.pos, key: idx}); //TODO
	},
	renderTree: function(item, idx) {
		if (typeof item == 'string' || item instanceof String)
			return span({key: idx, dangerouslySetInnerHTML:{__html: item}});
		switch(item.type) {
			case 'text': return span({key: idx, 'data-pos': item.pos, dangerouslySetInnerHTML:{__html: item.text}});
			case 'p': return p({'data-pos': item.pos, key: idx}, item.children.map(this.renderTree));
			case 'section': return DOM.section({'data-pos': item.pos, key: idx}, item.children.map(this.renderTree));
			case 'heading': return this.renderHeading(item, idx);
			case 'table': return this.renderTable(item, idx);
			case 'blockquote': return DOM.blockquote({'data-pos': item.pos, key: idx}, item.children.map(this.renderTree));
			case 'ul': return ul({'data-pos': item.pos, key: idx}, item.children.map(this.renderTree));
			case 'ol': return ol({'data-pos': item.pos, key: idx}, item.children.map(this.renderTree));
			case 'li': return li({'data-pos': item.pos, key: idx}, item.children.map(this.renderTree));
			case 'hr': return DOM.hr({'data-pos': item.pos, key: idx}); //TODO
			case 'code': return div({'data-pos': item.pos, key: idx}, 
				DOM.pre({key: '_'}, DOM.code({'data-pos': item.pos, key: '_'}, item.text))//, result TODO
				);
			case 'html': return div({'data-pos': item.pos, key: idx,
				dangerouslySetInnerHTML:{__html: item.raw}
				});
			default: return p({'data-pos': item.pos, key: idx},'unsupported: ' + item.type);
		};
	},
	render: function() {
		var ast = this.props.model._asts[this.props.name];
		if (ast === undefined)
			ast = [];
		return div({id: 'preview', 
			ref: 'preview',
			onMouseUp: this.handleMouseUp,
			className: 'editor', 
			//dangerouslySetInnerHTML:{__html: this.props.model._rendered[this.props.name]}
      		}, ast.map(this.renderTree)
      		); 
	},
});

var Editor = React.createClass({
	getInitialState: function() {
		return {
			//TODO this should be an empty model
			currentSource: 'Test of this',
			selected: 'Example',
			modal: this.preview,
			selectionRange: null,
		}
	},
	handleChange: function(e) {
		var source = this.refs.textarea.getDOMNode().value;
		this.setState({currentSource: source});
		this.props.model.update(this.state.selected, source);
	},
	save: function() { console.log('save'); },
	saveAll: function() { console.log('saveAll'); },
	open: function() {
		this.setState({modal: this.openModal});
	},
	close: function() { 
		this.props.model.close(this.state.selected);
		this.switchFile(this.props.model.names[0].name);
	},
	revert: function() {
		this.props.model.revert(this.state.selected, this.switchFile);
	},
	openFile: function(path) {
		this.props.model.openModel(path, this.switchFile);
	},
	preview: function() {
		return Renderer({model:this.props.model, 
			name:this.state.selected, 
			onmouseup:this.handleMouseUp,
		});
	},
	openModal: function() {
		return FileList({clicked: this.openFile});
	},
	switchFile: function(name) { 
		console.log('switchFile: ' + name);
		var source = this.props.model.getSource(name),
		    ta = this.refs.textarea.getDOMNode();
		this.setState({ selected: name,
			currentSource: source,
			modal: this.preview});
		ta.value = source; //React doesn't set the value of the text area
		ta.setSelectionRange(0,0);
	},
	componentDidMount: function() {
		this.openFile('Example'); //TODO pass in as initial model
	},
	componentDidUpdate: function(prevProps, prevState) {
		//
	},
	menu: function() {
		// must be wrapped in a function to see the other functions
		// i.e. this.openFile
		// could be done on ComponentWillMount to save a call every time
		return [
			{name: "Open", func: this.open},
			{name: "Close", func: this.close},
			{name: "Revert", func: this.revert},
			{name: "Save", func: this.save, separator: true},
			{name: "Save All", func: this.saveAll},
			];
	},
	updateCursor: function() {
		//TODO might want this to ignore the 
	},
	handleKeyDown: function(e) {
		if (e.keyCode === 9 && !e.altKey && !e.ctrlKey && !e.shiftKey) { //tab
			var ta = this.refs.textarea.getDOMNode(),
				val = ta.value,
				start = ta.selectionStart,
				end = ta.selectionEnd;
			ta.value = val.substring(0,start) + '\t' + val.substring(end);
			ta.selectionStart = ta.selectionEnd = start + 1;
			this.setState({currentSource: ta.value});
			//manually trigger update
			this.props.model.update(this.state.selected, ta.value);
			return false;
		}
		return true;
	},
	//Note: these are getting called every click...
	handleBlur: function() {
		if (this.state.selectionRange !== null)
			this.setState({selectionRange: null});
	},
	handleFocus: function() {
		//textarea gained focus (draw selection)
		this.updateCursor();
	},
	handleKeyUp: function() {
		this.updateCursor();
	},
	handleMouseUp: function(e) {
		var selected = window.getSelection(),
			range = selected.getRangeAt(0),
        	startE = range.startContainer.parentElement || range.startContainer.parentNode,
			endE = range.endContainer.parentElement || range.endContainer.parentNode,
			startPos = startE.getAttribute('data-pos'),
			endPos = endE.getAttribute('data-pos'),
			end = parseInt(endPos) + range.endOffset,
			start = parseInt(startPos) + range.startOffset,
			ta = this.refs.textarea.getDOMNode();
			ta.setSelectionRange(start, end);
			ta.focus();
			this.setState({selectionRange: range}); 
			//remove line above as the focus will do the trick by calling updateCursor
	},
	render: function() {
		return div(null,
			div({className: 'debug'},
				div({className: 'content'},
					DOM.textarea({id: 'model', 
						onChange: this.handleChange,
						onKeyDown: this.handleKeyDown,
						onkeyUp: this.handleKeyUp,
						onFocus: this.handleFocus,
						onBlur: this.handleBlur,
						ref: "textarea", 
						className: "editor pure-u-5-5",
						defaultValue: this.props.model.getSource(this.state.selected)}))),
			div({id:'layout'},
				MenuToggle(null),
				Menu({items: this.menu(), files:this.props.model.names, 
					selected:this.state.selected, fileClick: this.switchFile}),
				div({id:'main'},
					div({className:'content'},
						Selection({selection:this.state.selectionRange}),
						this.state.modal()))));
	},
});


var models = new Clay();
//models.addModel("Getting Started", "# Some stuff here\n\nOther stuff");
//models.addModel("Benchmarks","# Benchmarks\n\nNothing to see here");
var ed = Editor({model: models});
React.renderComponent(ed, document.body);
//ed.openFile('Example');
</script>
<script type="text/javascript">
	/*var model = document.getElementById('model');
	var preview = document.getElementById('preview');
	var cursor = document.getElementById('cursor');
	
	}*/
	var empty = /^\n*$/;
	var elementPath = function elementPath(root, elem, path) {
		var i = 0,
			parent = elem.parentNode
		path = path || [];
		if (elem === root) return path.reverse();
		while((elem=elem.previousSibling)!=null) {
			if (!(elem.nodeType === 3 && empty.test(elem.nodeValue))) ++i;
		};
		path.push(i);
		return elementPath(root,parent, path);
	}

	/*preview.innerHTML = clay(model.value);

	var update = _.debounce(function() { 
		//TODO check if the document is actually different.
		//console.time('#update');
		var nex = clay(model.value);
		//console.timeEnd('#update');
		//console.time('#render')
		preview.innerHTML = nex; 
		//console.timeEnd('#render');
	},20);
	model.onchange = update;
	
	model.onkeyup = function(e) {
		console.log('model onkeyup');
		//TODO 
		return true;
	}

	//TODO
	var drawSelection = function(range) {
		//given a preview range draw the cursor or selection
	}

	var selectText = function(range) {
		//given a preview range select model range

	}

	var selectedToRange = function() {
		// calculate preview selection from model selection
	}


	//clear selection if textarea loses focus
	model.onblur = function() {
		cursor.style.display = selection.style.display = 'none';
	}
*/
</script>

<script src="js/ui.js"></script>

</body>
</html>