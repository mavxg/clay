<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title></title>
	<script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,700|Inconsolata" />
<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/pure-min.css"/>

<!--[if lte IE 8]>
    <link rel="stylesheet" href="css/layouts/side-menu-old-ie.css">
<![endif]-->
<!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="css/layouts/side-menu.css">
<!--<![endif]-->


<script src="js/clay.js"></script>
<script src="js/parser.js"></script>
<link rel="stylesheet" href="/css/clay.css"/>
<style type="text/css">
.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}
</style>
</head>

<body>
<div class='debug'>
<div class='content'>
<textarea id="model" class="editor pure-u-5-5">
# Clay

Requires Chrome, Firefox, or IE9>.
</textarea>	
</div>
</div>
<div id="layout">
    <!-- Menu toggle -->

    <div id="main">
<div class="content">
	
<div id="preview" class="editor">
</div>
</div>
</div>
</div>
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
<script type="text/javascript" src="/js/react/react-with-addons.js"></script>
<script type="text/javascript" src="/js/functions.js"></script>
<script src="http://d3js.org/d3.v3.js"></script>
<script type="text/javascript">
var title = "Clay"
var DOM = React.DOM,
	div = DOM.div, ul = DOM.ul, li = DOM.li, p = DOM.p
	h1 = DOM.h1, h2 = DOM.h2, a = DOM.a, span = DOM.span;


//helper string functions
if (typeof String.prototype.startsWith != 'function') {
  String.prototype.startsWith = function (str){
    return this.slice(0, str.length) == str;
  };
}

var _defaultPakageName = 'Main';

var Model = function(name, source) {
	this.name = name;
	this.source = this.originalSource = source.replace(/\r\n/g,'\n');
	this.package = _defaultPakageName
	this.expressions = {};
	this.functions =  {};
	this.properties = {}; //meta
	this.ast = {type: 'root', children: []};
	this.recalculate();
};

Model.prototype.isModified = function() {
	return this.source != this.originalSource;
};

Model.prototype.update = function(source) {
	var s = source.replace(/\r\n/g,'\n');
	if (s != this.source) {
		this.source = s;
		this.recalculate();
	}
};

Model.prototype.revert = function() {
	if (this.originalSource != this.source) {
		this.source = this.originalSource;
		this.recalculate();
	}
};

Model.prototype.recalculate = function() {
	var lex = clay.lexer(this.source);
	this.ast.children = clay.parser(lex);
	//collect properties, code, tables
	var properties = {}, code = [], tables = [];
	depthFirstVisit(this.ast, function(node, depth, parent, idx) {
		var nodetype = node.type
		if (nodetype === 'meta') {
			if (properties.hasOwnProperty(node.head)) {
				//insert an error into the ast after the node.
				parent.children[idx] = {type: 'error', pos: node.pos,
					text: 'Property {' + node.head + '} already defined as: ' + properties[node.head],
					children: [node]};
			} else {
				properties[node.head] = node.value;
			}
			return true; // don't recurse to children
		} else if (nodetype === 'code' || nodetype === 'codespan') {
			code.push(node);
		} else if (nodetype === 'table') {
			tables.push(node);
		}
	});
	this.properties = properties;
	this.package = this.properties['package'] || _defaultPakageName;
};


Model.prototype.charOffset = function(path, toff) {
	var node = this.ast, path = path.reverse(), cur, off = 0, row;
	while ((cur = path.pop()) !== undefined) {
		if (cur === '_') continue;
		else if (cur === 'result') return node.pos + node.length; //off + // no toff
		node = node.children[cur];
		if (node === undefined) return off + toff;
		off = node.pos; //+= //change pos to be against level
		if (node.type === 'table') {
			switch(cur = path.pop()) {
				case 'body':
					row = path.pop();
					cur = path.pop();
					node = {children: node.cells[row][cur]};
					break;
				case 'head':
					row = path.pop(); //should be 0
					cur = path.pop();
					if (row === 'align') {
						off = node.align.pos;
						for (var i = 0; i < cur; i++) {
							off += node.alignText[i].length + 1;
						}
						return off + toff;
					} else {
						node = {children: node.header[cur]};
					}
					break;
				//case 'foot': 
				//	return off + toff; //TODO: don't support foot yet
			}
		}
	}
	return off + toff;
};

var Blank = new Model('Blank', '# Blank\n\nEnter your model here.');

//f should return undefined to visit children
// false to skip rest of tree
// any other value to just skip children
function depthFirstVisit(node, f, depth, parent, index) {
	if (depth === undefined) depth = 0;
	var r = f(node, depth, parent, index);
	if (r === undefined && node.hasOwnProperty('children')) {
		depth += 1;
		var i, cs = node.children, l = cs.length;
		for (i = 0; i < l; i++) {
			if (depthFirstVisit(cs[i],f, depth, node, i) === false) {
				return false;
			}
		}
	}
	return r;
}


var Clay = function() {
	this.models = [Blank];
	this._models = {'Blank': Blank};
	this._environment;
};


var Graph = {};

Graph.Line = function(matrix, x, series) {
	var elem = document.createElement('div');

// DUMMY graph to test the result concept

	var margin = {top: 20, right: 30, bottom: 30, left: 30},
    width = 800 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var parseDate = d3.time.format("%Y%m%d").parse;

var x = d3.time.scale()
    .range([0, width]);

var y = d3.scale.linear()
    .range([height, 0]);

var color = d3.scale.category10();

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");

var line = d3.svg.line()
    .interpolate("basis")
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y(d.temperature); });

var svg = d3.select(elem).append('svg')
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

d3.tsv("data.tsv", function(error, data) {
  color.domain(d3.keys(data[0]).filter(function(key) { return key !== "date"; }));

  data.forEach(function(d) {
    d.date = parseDate(d.date);
  });

  var cities = color.domain().map(function(name) {
    return {
      name: name,
      values: data.map(function(d) {
        return {date: d.date, temperature: +d[name]};
      })
    };
  });

  x.domain(d3.extent(data, function(d) { return d.date; }));

  y.domain([
    d3.min(cities, function(c) { return d3.min(c.values, function(v) { return v.temperature; }); }),
    d3.max(cities, function(c) { return d3.max(c.values, function(v) { return v.temperature; }); })
  ]);

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Net Income");

  var city = svg.selectAll(".city")
      .data(cities)
    .enter().append("g")
      .attr("class", "city");

  city.append("path")
      .attr("class", "line")
      .attr("d", function(d) { return line(d.values); })
      .style("stroke", function(d) { return color(d.name); });

  city.append("text")
      .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; })
      .attr("transform", function(d) { return "translate(" + x(d.value.date) + "," + y(d.value.temperature) + ")"; })
      .attr("x", 3)
      .attr("dy", ".35em")
      .text(function(d) { return d.name; });
});

	return ['element', elem];
};

var dummy = {};
dummy['(. (Symbol Graph) (Call (Symbol Line) (Symbol `Net Income`) (Slice (Symbol Month)) (Slice (Symbol Growth))))'] = Graph.Line();


Clay.prototype.evaluate = function(package, expression) {
	//TODO: replace this with real expression evaluation.
	var e = clay.code.show(expression);
	if (dummy.hasOwnProperty(e))
		return dummy[e];
	return null;
};

Clay.prototype.model = function(name) {
	return this._models[name];
};

Clay.prototype.recalculate = function() {
	//TODO: ... recalculate (not reparse)
};

Clay.prototype.addModel = function(model) {
	if (this.models.length === 1 && this.models[0] === Blank && !Blank.isModified()) {
		this.models = [];
		this._models = {};
	}
	this.models.push(model);
	this._models[model.name] = model;
	this.recalculate();
};

Clay.prototype.close = function(name) {
	var m = this._models[name];
	delete this._models[name];
	var i = this.models.length;
	while (i--)
		if (this.models[i] === m) 
			break;
	if (i >= 0)
		this.names.splice(i, 1);
	this.recalculate();
};

Clay.prototype.charOffset = function(name, path, toff) {
	return this.model(name).charOffset(path, toff);
};

Clay.prototype.openModel = function(name, callback) {
	if (this._models[name] !== undefined) {
		if (callback) callback(name); //file already open just switch to it
	} else {
		fetchFile('/models/'+name + '.model', function(data) {
			if (data !== undefined) {
				this.addModel(new Model(name, data));
				if (callback) callback(name);
			}
		}.bind(this));
	}
};

Clay.prototype.revert = function(name, callback) {
	this.model(name).revert();
	if (callback) callback(name);
};

Clay.prototype.update = function(name, source) {
	this.model(name).update(source);
};

Clay.prototype.name = function(name) {
	var i = this.names.length;
	while (i--)
		if (this.names[i].name == name)
			return this.names[i];
	return {}
};

var MenuToggle = React.createClass({
	render: function() {
		return a({href:"#menu", id:"menuLink", className:"menu-link"}, span(null));
	},
});

var MenuItem = React.createClass({
	clicked: function(event) {
		this.props.clicked(this.props.item.name);
	},
	render: function() {
		var item = this.props.item,
			classes = React.addons.classSet({
			'menu-item-divided': this.props.divided,
			'pure-menu-selected': this.props.selected,
			'menu-modified': item.isModified && item.isModified(),
		});
		return li({onClick: this.clicked, className: classes},
			a({href:"#" + item.name}, item.name))
	},
});

var Menu = React.createClass({
	renderItem: function(item,idx) {
		return MenuItem({item:item, 
			key: idx,
			divided: item.separator, 
			selected: (item.name == this.props.selected), 
			clicked: item.func});
	},
	renderFile: function(item, idx) {
		return MenuItem({item:item, 
			divided: (idx == 0),
			key: idx,
			selected: (item.name == this.props.selected), 
			clicked: this.props.fileClick});
	},
	render: function() {

		return div({id:"menu"},
			div({className:"pure-menu pure-menu-open"},
				a({className:"pure-menu-heading", href:"#"},title),
				ul(null,this.props.items.map(this.renderItem),
					this.props.files.map(this.renderFile))));
	},
});

var FileItem = React.createClass({
	clicked: function(event) {
		this.props.clicked(this.props.path + this.props.item.name.replace(/\.model$/,''));
	},
	render: function() {
		var item = this.props.item.name,
			name = this.props.path + item.replace(/\.model$/,'');
		return li({onClick: this.clicked},
			a({href:"#" + name}, name))
	},
});

var DirectoryItem = React.createClass({
	renderItem: function(item, idx) {
		if (item.type === 'directory') {
			return DirectoryItem({clicked: this.props.clicked,
				key: idx,
				directory: item,
				path: this.props.path + item.name + '/'});
		}
		return FileItem({clicked: this.props.clicked, key: idx, item: item, path: this.props.path});
	},
	render: function() {
		return ul({className: 'models'}, this.props.directory.children.map(this.renderItem));
	},
});

var FileList = React.createClass({
	getInitialState: function() {
		return {data: []};
	},
	componentWillMount: function() {
		$.ajax({
			url: 'models.json',
			dataType: 'json',
			success: function(data) {
				this.setState({data: data});
			}.bind(this),
			error: function(xhr, status, err) {
				console.error('models.json', status, err.toString());
			}.bind(this)
		});
	},
	render: function() {
		return div(null,
			div({className: 'header'}, h1(null, "Open Model"), h2(null, "Choose a model to open")),
			DirectoryItem({directory:{children: this.state.data}, path:'', clicked: this.props.clicked}));
	},
});

var Selection = React.createClass({
	getInitialState: function() {
		return {
			selection: null,
		}
	},
	componentDidUpdate: function() {
		/*var rects, rect;
		if (this.state.selection !== null &&
			(rects = this.state.selection.getClientRects()).length > 0) {
			rect = rects[0];
			window.scrollTo(rect.left, rect.top);
		}*/
	},
	renderSelection: function(range) {
		var rects = range.getClientRects(),
			r = range.getBoundingClientRect()
		  , ret = []
		  , cs
		  , fbot
		  , rect
		  , farLeft = Math.floor(r.left)
		  , farRight = Math.ceil(r.right)
		  , scrollTop = document.documentElement.scrollTop || document.body.scrollTop
          , scrollLeft = document.documentElement.scrollLeft || document.body.scrollLeft
          , len = rects.length
          , i;
        if (len > 0) {
        	rect = rects[0];
        	cs = {
        		top: (rect.top + scrollTop) + 'px',
        		left: (rect.left + scrollLeft) + 'px',
        		height: rect.height + 'px',
        		width: (farRight - rect.left) + 'px',
        	}
			fbot = rect.bottom;
        	ret.push(div({style:cs, key:'first'}," "));
        }
        if (len > 1) {
        	rect = rects[len - 1];
        	cs = {
        		left: (farLeft + scrollLeft) + 'px',
        		width: (rect.right - farLeft) + 'px',
        	}
			var gap = rect.top - fbot;
			if (gap < rect.height * 0.6) {
				cs.top = (rect.top + scrollTop - gap) + 'px';
        		cs.height = (rect.height + gap) + 'px';
			} else {
        		cs.top = (rect.top + scrollTop) + 'px';
        		cs.height = rect.height + 'px';
        		// now draw the gap
        		ret.push(div({style: {
        			top: (fbot + scrollTop) + 'px',
        			left: (farLeft + scrollLeft) + 'px',
        			width: (farRight - farLeft) + 'px',
        			height: gap + 'px'
        		}, key: 'mid'}, " "));
			}
			ret.push(div({style: cs, key: 'last'}, " "));
        }
        return ret;
	},
	render: function() {
		var range = this.state.selection; //selection range
		if (range === null)
			return div(null);

		var rects = range.getClientRects(),
			scrollTop = document.documentElement.scrollTop || document.body.scrollTop,
        	scrollLeft = document.documentElement.scrollLeft || document.body.scrollLeft;
        if (rects.length === 0)
        	return div(null);

		if (range.collapsed) {
			var rect = rects[0],
				cs = {
					top: (rect.top + scrollTop) + 'px',
					left: (rect.right + scrollLeft - 1) + 'px',
					height: rect.height + 'px',
					display: 'block',
				};
			return div(null,span({className: "cursor", style: cs}, " "));
		} else {
			return div({className: "selection"},
				this.renderSelection(range));
		}
	},
});

var Result = React.createClass({
	componentDidMount: function() {
		if (this.props.value instanceof Array && this.props.value[0] === 'element') {
			var el = this.getDOMNode(), last;
			while (last = el.lastChild) el.removeChild(last);
			el.appendChild(this.props.value[1]);
		}
	},
	componentDidUpdate: function() {
	},
	render: function() {
		if (this.props.inline)
			return span({className: 'result'});
		else
			return div({className: 'result'}, clay.code.show(this.props.value));
	},
});

var Renderer = React.createClass({
	rangeFor: function(start, end) {
		var rootId = this._rootNodeID + '.',
			range = document.createRange(),
			ast = this.props.model.model(this.props.name).ast.children;
		function setEnd(items, pos, isStart) {
			var item,
			i,l,path = [];
			while(items !== undefined) {
				l = items.length;
				for(i = 0; i < l; i++) {
					item = items[i];
					if (item.pos > pos) {
						break;
					}
				}
				item = items[--i];
				path.push('$' + i);
				switch(item.type) {
					case 'code':
						//path.push('$_'); //pre
						path.push('$_'); //code
						break;
					//case 'codespan':
					//	path.push('$_'); //code
					//	break;
					case 'table':
						if (pos < item.cells.pos) {
							path.push('$head');
							if (pos < item.align.pos) {
								path.push('$0');
								item = item.header;
							} else {
								path.push('$align');
								var tw = item.align.pos,w;
								for (i = 0; i < item.alignText.length; i++) {
									w = item.alignText[i].length + 1;
									if (pos < w + tw) {
										path.push('$' + i);
										item = {pos: tw};
										break;
									}
									tw += w;
								}
							}
						}
						else {
							path.push('$body');
							item = item.cells;
						}
						break;
				}
				if (item.hasOwnProperty('children')) {
					items = item.children;
				} else if ($.isArray(item)) {
					//items are a
					items = item;
				} else {
					items = undefined;
					pos -= item.pos;
				}
			}
			var x = $('[data-reactid="'+ rootId + path.join('.')+'"]')[0];
			if (x !== undefined)
				if (isStart)
					if (pos > x.firstChild.length) {
						range.setStartAfter(x.firstChild);
					}
					else {
						range.setStart(x.firstChild, pos);
					}
				else
					if (pos > x.firstChild.length) {
						range.setEndAfter(x.firstChild);
					}
					else {
						range.setEnd(x.firstChild, pos);
					}
		}
		setEnd(ast, start, true);
		if (start === end)
			range.setEnd(range.startContainer, range.startOffset);
		else
			setEnd(ast, end, false);
		return range;
	},
	handleMouseUp: function(e) {
		var x = this.props.selectionChanged;
		if (x) {
			//calculate the selection from the data-ids
			var selected = window.getSelection();
			if (selected.rangeCount < 1)
				return;
			var range = selected.getRangeAt(0),
				startE = range.startContainer.parentElement || range.startContainer.parentNode,
				endE = range.endContainer.parentElement || range.endContainer.parentNode,
				startPath = startE.getAttribute('data-reactid'),
				endPath = endE.getAttribute('data-reactid'),
				rootId = this._rootNodeID + '.';
			if (startPath !== undefined 
				&& endPath !== undefined
				&& startPath.startsWith(rootId)
				&& endPath.startsWith(rootId)) {
				var model = this.props.model, name = this.props.name;
				startPath = startPath.slice(rootId.length).replace(/\$?/g,'').split('.');
				endPath = endPath.slice(rootId.length).replace(/\$?/g,'').split('.');
				var start = model.charOffset(name,startPath, range.startOffset);
				var end = model.charOffset(name,endPath, range.endOffset);
				x(start, end);
			}
		}
	},
	renderHeading: function(item, idx) {
		var id = this.props.name + '-' + item.id,
			content = item.children.map(this.renderTree),
			attr = {id: id, key: idx};
		switch(item.depth) {
			case 1: return h1(attr, content);
			case 2: return h2(attr, content);
			case 3: return DOM.h3(attr, content);
			case 4: return DOM.h4(attr, content);
			case 5: return DOM.h5(attr, content);
			case 6: return DOM.h6(attr, content);
		}
		return h1(attr, content);
	},
	renderCode: function(item, idx) {
		return DOM.pre({key: idx}, DOM.code({key: '_'}, item.children.map(this.renderTree)));
	},
	renderTable: function(item, idx) {
		var align = item.align, rtree = this.renderTree;
		function renderCell(f) {
			return function(c, idx) {
				var a = align[idx], ctx = {key:idx};
				if (a !== null) {
					ctx['style'] = {'text-align': a};
				}
				return f(ctx, c.map(rtree)); 
			}
		}
		function renderTR(r, idx) {
			return DOM.tr({key: idx}, r.map(renderCell(DOM.td)));
		}
		function renderAlign(c, idx) {
			var a = align[idx], ctx = {key:idx};
				if (a !== null) {
					ctx['style'] = {'text-align': a};
			}
			return DOM.td(ctx, c);
		}
		return DOM.table({key: idx, className: 'pure-table pure-table-horizontal'},
			DOM.thead({key:'head'},
				DOM.tr({key: 0}, item.header.map(renderCell(DOM.th))),
				DOM.tr({key: 'align', className: 'align'}, item.alignText.map(renderAlign))),
			DOM.tbody({key:'body'},item.cells.map(renderTR))//,
			//DOM.tfoot({key:'foot'})
			);
	},
	renderResult: function(item, idx) {
		var inline = false,
			expressions = item.code.sexpr,
			models = this.props.model,
			model = models.model(this.props.name),
			p = model.package;

			if (item.code.type === 'codespan') {
				inline = true;
				expressions = [expressions];
			}
			
			var results = clay.code.expressions(expressions)
				.map(function(e,i) { return models.evaluate(p, e); })
				.filter(function(r) { return r !== null; });

			return results.map(function(r, i) { return Result({key: idx + '_' + i, value: r, inline: inline}); });

	},
	renderTree: function(item, idx) {
		switch(item.type) {
			case 'text': return span({key: idx},item.text);
			case 'escape': return span({key: idx, dangerouslySetInnerHTML:{__html: item.text}});
			case 'span': return span({key: idx}, item.children.map(this.renderTree));
			case 'meta': return span({key: idx, className: 'meta'}, item.text);
			case 'before': return span({className: 'before', key:idx}, 
				item.text.replace(/ /g,'\u2423').replace(/\t/,'\u2192')); // + (item.newline ? '\n' : '')
			case 'after': 
				var text = item.text.replace(/ /g,'\u2423').replace(/\n/g,'\u00AC');
				if (text.length === 0)
					text = ' '
				return span({className: 'after', key:idx},  text);
			case 'p': return p({key: idx}, item.children.map(this.renderTree));
			case 'em': return DOM.em({key: idx}, item.children.map(this.renderTree));
			case 'strong': return DOM.strong({key: idx}, item.children.map(this.renderTree));
			case 'del': return DOM.del({key: idx}, item.children.map(this.renderTree));
			case 'a': return DOM.a({key: idx, href: item.href, title: item.title}, item.children.map(this.renderTree));
			case 'section': return DOM.section({key: idx}, item.children.map(this.renderTree));
			case 'heading': return this.renderHeading(item, idx);
			case 'table': return this.renderTable(item, idx);
			case 'blockquote': return DOM.blockquote({key: idx}, item.children.map(this.renderTree));
			case 'ul': return ul({key: idx}, item.children.map(this.renderTree));
			case 'ol': return ol({key: idx}, item.children.map(this.renderTree));
			case 'li': return li({key: idx}, item.children.map(this.renderTree));
			case 'hr': return DOM.hr({key: idx}); //TODO
			case 'br': return DOM.br({key: idx}); //TODO
			case 'code': return this.renderCode(item, idx);
			case 'codespan': return DOM.code({key: idx}, item.text);
			case 'error': 
				var children = item.children.map(this.renderTree);
				children.push(span({className: 'error'}, item.text));
				return div({key: idx}, children);
			case 'html': return div({key: idx,
				dangerouslySetInnerHTML:{__html: item.raw}
				});
			case 'result': return this.renderResult(item, idx);
			default: return p({key: idx},'unsupported: ' + item.type);
		};
	},
	render: function() {
		var model = this.props.model.model(this.props.name);
		if (model === undefined)
			ast = {type:'root', children: []};
		else
			ast = model.ast;
		return div({id: 'preview', 
			ref: 'preview',
			onMouseUp: this.handleMouseUp,
			className: 'editor', 
      		}, ast.children.map(this.renderTree)
      		); 
	},
});

var Editor = React.createClass({
	getInitialState: function() {
		return {
			//TODO this should be an empty model
			currentSource: 'Test of this',
			selected: 'Blank',
			modal: null,
		}
	},
	handleChange: function(e) {
		var source = this.refs.textarea.getDOMNode().value;
		this.setState({currentSource: source});
		this.props.model.update(this.state.selected, source);
	},
	save: function() { console.log('save'); },
	saveAll: function() { console.log('saveAll'); },
	open: function() {
		this.setState({modal: this.openModal});
	},
	close: function() { 
		this.props.model.close(this.state.selected);
		this.switchFile(this.props.model.names[0].name);
	},
	revert: function() {
		this.props.model.revert(this.state.selected, this.switchFile);
	},
	openFile: function(path) {
		this.props.model.openModel(path, this.switchFile);
	},
	newFile: function() {
		this.setState({modal: this.newModal});
	},
	preview: function() {
		return 
	},
	openModal: function() {
		return FileList({clicked: this.openFile});
	},
	newModal: function() {
		return div(null, p(null, 'TODO: put form here with a box for model name'));
	},
	switchFile: function(name) { 
		console.log('switchFile: ' + name);
		var source = this.props.model.model(name).source,
		    ta = this.refs.textarea.getDOMNode();
		this.setState({ selected: name,
			currentSource: source,
			modal: null});
		ta.value = source; //React doesn't set the value of the text area
		ta.setSelectionRange(0,0);
	},
	componentDidMount: function() {
		this.openFile('Example'); //TODO pass in as initial model
	},
	componentDidUpdate: function(prevProps, prevState) {
		this.updateCursor();
	},
	menu: function() {
		// must be wrapped in a function to see the other functions
		// i.e. this.openFile
		// could be done on ComponentWillMount to save a call every time
		return [
			{name: "Open", func: this.open},
			{name: "Close", func: this.close},
			{name: "Revert", func: this.revert},
			{name: "Save", func: this.save, separator: true},
			{name: "Save All", func: this.saveAll},
			{name: "New", func: this.newFile, separator: true},
			];
	},
	updateCursor: function() {
		//TODO might want this to ignore the 
		var ta = this.refs.textarea.getDOMNode(),
		    range = this.refs.preview.rangeFor(ta.selectionStart, ta.selectionEnd);
		this.refs.selection.setState({selection: range});
	},
	handleKeyDown: function(e) {
		if (e.keyCode === 9 && !e.altKey && !e.ctrlKey && !e.shiftKey) { //tab
			var ta = this.refs.textarea.getDOMNode(),
				val = ta.value,
				start = ta.selectionStart,
				end = ta.selectionEnd;
			ta.value = val.substring(0,start) + '\t' + val.substring(end);
			ta.selectionStart = ta.selectionEnd = start + 1;
			this.setState({currentSource: ta.value});
			//manually trigger update
			this.props.model.update(this.state.selected, ta.value);
			return false;
		} else if (e.keyCode === 13 && !e.altKey && !e.ctrlKey && !e.shiftKey) { //return
			var ta = this.refs.textarea.getDOMNode(),
				val = ta.value,
				start = ta.selectionStart,
				end = ta.selectionEnd,
				lineStart = val.lastIndexOf('\n',start-1) + 1;
			if (start === end && /^\n\t(\n|$)/.test(val.slice(start-2,start+1))) {
				ta.value = val.substring(0,start-1) + '\n' + val.substring(end);
				ta.selectionStart = ta.selectionEnd = start;
				this.setState({currentSource: ta.value});
				//manually trigger update
				this.props.model.update(this.state.selected, ta.value);
				return false;
			} else if (val.slice(lineStart,lineStart+1) === '\t' || val.slice(lineStart,lineStart + 4) === '    ') {
				ta.value = val.substring(0,start) + '\n\t' + val.substring(end);
				ta.selectionStart = ta.selectionEnd = start + 2;
				this.setState({currentSource: ta.value});
				//manually trigger update
				this.props.model.update(this.state.selected, ta.value);
				return false;
			}
		}
		return true;
	},
	//Note: these are getting called every click...
	handleBlur: function() {
		this.refs.selection.setState({selection: null});
	},
	handleFocus: function() {
		//textarea gained focus (draw selection)
		this.updateCursor();
	},
	handleKeyUp: function() {
		this.updateCursor();
	},
	handleSelect: function(start, end) {
		var ta = this.refs.textarea.getDOMNode();
		ta.setSelectionRange(start, end); //do this before and after focus so update cursor works
		ta.focus();
		ta.setSelectionRange(start, end); //TODO: remove (just here to scroll the text area)
		this.updateCursor();
	},
	render: function() {
		return div({className: (this.state.modal !== null ? "modal" : "view")},
			DOM.textarea({id: 'model', 
						onChange: this.handleChange,
						onKeyDown: this.handleKeyDown,
						onKeyUp: this.handleKeyUp,
						onFocus: this.handleFocus,
						onBlur: this.handleBlur,
						ref: "textarea", 
						style: {opacity: '0', position: 'fixed', width: '100%', 'max-width': '800px'},
						value: this.state.value}),
			div({id:'layout'},
				MenuToggle(null),
				Menu({items: this.menu(), files:this.props.model.models, 
					selected:this.state.selected, fileClick: this.switchFile}),
				div({id:'main'},
					div({className:'content'},
						Selection({ref: 'selection'}),
						(this.state.modal === null ? null : this.state.modal()), //Dialog box
						Renderer({model:this.props.model, 
							ref: 'preview',
							name:this.state.selected,
							selectionChanged: this.handleSelect,
							})
						))));
	},
});


var models = new Clay();
var ed = Editor({model: models});
React.renderComponent(ed, document.body);
//ed.openFile('Example');
</script>
<script src="js/ui.js"></script>
</body>
</html>