<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title></title>
	<!--script src="http://code.jquery.com/jquery-1.10.0.min.js"></script-->
<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,700|Inconsolata" />
<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/pure-min.css"/>

<!--[if lte IE 8]>
    <link rel="stylesheet" href="css/layouts/side-menu-old-ie.css">
<![endif]-->
<!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="css/layouts/side-menu.css">
<!--<![endif]-->


<script src="js/clay.js"></script>
<style>
html { font-family: "Open Sans","Segoe UI",verdana , sans-serif; 
background: #fff; color: #777; }

table {
	min-width: 100%;
}

h1, h2, h3, h4, h5, h6 {
color: rgb(75, 75, 75);
text-rendering: optimizeLegibility;
line-height: 1;
margin-top: 0;
font-weight: 300;
}

#preview h1 { font-size: 50.66px;
font-family: "Open Sans", "Segoe UI Light","Segoe WP Light", verdana , sans-serif; 
}
#preview h2 {  
padding-top: 0.8em;
margin-top: 0.8em;
border-top: #edece4 1px solid;
}

pre {
margin: 1.6em 0;
box-sizing: border-box;
background: rgb(250, 250, 250);
border: 1px solid #eee;
width: 100%;
padding: 10px;
font-size: 0.9em;
/*white-space: pre;*/
/*border-radius: 3px;*/
}

code, kbd, pre, samp {
font-family: Consolas, Inconsolata, monospace;
font-size: 1em;
color: #333;
}

pre code, pre tt {
font-size: inherit;
/*white-space: -moz-pre-wrap;*/
white-space: pre-wrap;
background: transparent;
border: none;
padding: 0;
}

blockquote {
margin: 1.6em 0;
box-sizing: border-box;
padding: 0 1.6em 0 1.6em;
border-left: #edece4 0.6em solid;
}

#main {
	padding-top: 130px; /* TODO If you add margin then you need to take that into account for the cursor */
}

#preview {
	position: relative;
	box-sizing: border-box;
}

#model {
	height: 100px;
	background: white;
	border: 1px solid #efefef;
}


span.cursor {
  position: absolute;
  background: #111;
  margin-right: -1px;
  width: 1px;
  display: none;
 
  -webkit-animation: blink 2s linear 0s infinite;
  -moz-animation: blink 2s linear 0s infinite;
  -ms-animation: blink 2s linear 0s infinite;
  -o-animation: blink 2s linear 0s infinite;
}

@-webkit-keyframes blink {
  0%   { background: #aa0 }
  47%  { background: #999 }
  50%  { background: #000 }
  97%  { background: #000 }
  100% { background: #090 }
}
 
@-moz-keyframes blink {
  0%   { background: #aa0 }
  47%  { background: #999 }
  50%  { background: #000 }
  97%  { background: #000 }
  100% { background: #999 }
}
 
@-ms-keyframes blink {
  0%   { background: #aa0 }
  47%  { background: #999 }
  50%  { background: #000 }
  97%  { background: #000 }
  100% { background: #999 }
}
 
@-o-keyframes blink {
  0%   { background: #aa0 }
  47%  { background: #999 }
  50%  { background: #000 }
  97%  { background: #000 }
  100% { background: #999 }
}

h1 .before,
h2 .before,
h3 .before,
h4 .before,
h5 .before {
	position: absolute;
	right: 100%;
	margin-right: 3px;
}

span.before,
span.after {
	color: rgb(202, 224, 243);
}

#models {
	list-style-type: none;
	margin: 0;
	padding: 0;
	padding-bottom: 3em;
	text-align: center;
}

#models li {
	padding: 0.8em 0;
	background: #f7f7f7;
	border-bottom: 1px solid #e7e7e7;
}

#models a {
	text-decoration: none;
}


.debug { 
	position: fixed;
	top: 0;
	left: 0;
	right: 0px;
	z-index: 100;
}
@media (min-width: 48em) {
	.debug {
		margin-left: 150px;	
	}
}
</style>
</head>

<body>
<span id="cursor" class="cursor">&nbsp;</span>
<div class='debug'>
<div class='content'>
<textarea id="model" class="editor pure-u-5-5">
# Clay

Requires Chrome, Firefox, or IE9>.
</textarea>	
</div>
</div>
<div id="layout">
    <!-- Menu toggle -->
    <a href="#menu" id="menuLink" class="menu-link">
        <!-- Hamburger icon -->
        <span></span>
    </a>

    <div id="menu">
        <div class="pure-menu pure-menu-open">
            <a class="pure-menu-heading" href="#">Clay</a>

            <ul>
                <li><a href="#">Save</a></li>
                <li><a href="#">Save All</a></li>
                <li class="menu-item-divided pure-menu-selected"><a href="#">Example</a></li>
                <li><a href="#">Benchmarks</a></li>


            </ul>
        </div>
    </div>

    <div id="main">
<div class="content">
	<div id="index">
		<div class="header">
			<h1>Models</h1>
			<h2>Clay for modelling</h2>
		</div>
		<ul id="models">
		</ul>
	</div>
<div id="preview" class="editor">
</div>
</div>
</div>
</div>
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
<script type="text/javascript" src="/js/functions.js"></script>
<script type="text/javascript">
	var model = document.getElementById('model');
	var preview = document.getElementById('preview');
	var cursor = document.getElementById('cursor');
	
	var openModel = function(path) {
		fetchFile('/models/'+path + '.md', function(data) {
			model.value = data;
			update();
		});
	}
	
	var updateModelIndex = function(data) {
		console.log(data);
		var models = document.getElementById('models');
		models.innerHTML = '';
		data.forEach(function(name) {
			var a = document.createElement('a')
			  , li = document.createElement('li');
			li.appendChild(a); 
			a.href = '#' + name;
			a.onclick = function() { 
				openModel(name); return false; 
			};
			a.innerText = name;
			models.appendChild(li);
		});
	}
	
	fetchJSONFile('models.json', updateModelIndex);
	
	preview.innerHTML = clay(model.value);

	var update = _.debounce(function() { 
		console.time('#update');
		var nex = clay(model.value);
		console.timeEnd('#update');
		console.time('#render')
		preview.innerHTML = nex; 
		console.timeEnd('#render');
	},20);
	model.onchange = update;
	model.onkeyup = update;

	preview.onmouseup = function(e) {
		var selected = window.getSelection(),
			range = selected.getRangeAt(0),
			rects = range.getClientRects(),
			scrollTop = document.documentElement.scrollTop || document.body.scrollTop,
        	scrollLeft = document.documentElement.scrollLeft || document.body.scrollLeft,
        	cs = cursor.style,
        	start, end;
		if (selected.isCollapsed) {
			//caret
			var par = range.startContainer.parentElement || range.startContainer.parentNode,
				rect = rects[0],
				endPos = par.getAttribute('pos');
			if (endPos) {
				cs.top = (rect.top + scrollTop) + 'px';
				cs.left = (rect.right + scrollLeft - 1) + 'px';
				cs.height = rect.height + 'px';
				cs.display = 'block';
				end = parseInt(endPos) + range.startOffset;
				model.focus();
				model.setSelectionRange(end,end);
			}
		} else {
			//range
			var startE = range.startContainer.parentElement || range.startContainer.parentNode,
				endE = range.endContainer.parentNode || range.endContainer.parentNode,
				startPos = startE.getAttribute('pos'),
				endPos = endE.getAttribute('pos')
			if (startPos &&
				endPos) {
				cs.display = 'none';
				end = parseInt(endPos) + range.endOffset;
				start = parseInt(startPos) + range.startOffset;
				model.focus();
				model.selectionStart = start;
				model.selectionEnd = end;
			}
		}
	}
</script>

<script src="js/ui.js"></script>

</body>
</html>